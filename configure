#!/bin/sh
#  Based on configure of Rblpapi
#  https://github.com/Rblp/Rblpapi/blob/master/configure

## Check that we are on Unix
if ! [ -x $(command -v uname) ]; then
    echo "You do not have 'uname' so this is unlikely to be a Unix system. Exiting."
    exit 1
fi

## Check for Linux or OSX
: ${R_HOME=$(R RHOME)}
sysname=$(${R_HOME}/bin/Rscript -e 'cat(Sys.info()["sysname"])')
if [ ${sysname} = "Linux" ]; then
    platform="lnx"
elif [ ${sysname} = "Darwin" ]; then
    platform="mac"
    if [ $(uname -m) = "aarch64" ]; then
      echo "Unsupported platform: $sysname"
      exit 2
    fi
else
    echo "Unsupported platform: $sysname"
    exit 2
fi

ARCH=$(uname -m)

# Library settings
rpath=$(${R_HOME}/bin/Rscript -e 'cat(file.path(.libPaths()[1], "elbird", "lib"))')
PKG_TEST_HEADER="<kiwi/Kiwi.h>"
PKG_LIBS="-Wl,-rpath,${rpath}"
PKG_CPPFLAGS="-I`pwd`/inst/include"
LIB_VER="0.11.0"

LIB_URL=https://github.com/bab2min/Kiwi/releases/download/v${LIB_VER}/kiwi_${platform}_${ARCH}_v${LIB_VER}.tgz

echo ${LIB_URL}

# Check for custom locations
if [ "$INCLUDE_DIR" ] || [ "$LIB_DIR" ]; then
  echo "Found INCLUDE_DIR and/or LIB_DIR!"
  PKG_CPPFLAGS="-I$INCLUDE_DIR $PKG_CPPFLAGS"
  PKG_LIBS="-L$LIB_DIR $PKG_LIBS"

else
  echo "Prior system libkiwi installation not found"
  echo "Preparing to download and build library from source..."
  curl -L ${LIB_URL} -o kiwi.tgz
  gzip -dc kiwi.tgz | tar -xf -
  rm -f kiwi.tgz

  # mkdir -p inst/lib
  mkdir -p ${rpath}
  # cp -rf build/libkiwi.so* inst/lib
  cp -rf build/libkiwi.* ${rpath}
  rm -rf build
  PKG_LIBS="-lkiwi -L${rpath} $PKG_LIBS"
fi

# For debugging
# echo "Using PKG_CPPFLAGS=$PKG_CPPFLAGS"
# echo "Using PKG_LIBS=$PKG_LIBS"

# Find compiler
CXX11=`${R_HOME}/bin/R CMD config CXX11`
CXXFLAGS=`${R_HOME}/bin/R CMD config CXXFLAGS`

# Test for libkiwi
echo "#include $PKG_TEST_HEADER" | ${CXX11} ${PKG_CPPFLAGS} ${CXXFLAGS} -E -xc++ - >/dev/null 2>&1

if [ $? -ne 0 ]; then
  echo "------------------------------[ ELBIRD ]------------------------------"
  echo "Configuration failed because 'libkiwi' was not found."
  echo "If 'libkiwi' is already installed but in a non-standard location, you"
  echo "may set INCLUDE_DIR and LIB_DIR manually via:"
  echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
  echo "-------------------------------------------------------------------------"
  exit 1
fi

# Write to Makevars
sed -e "s|@cppflags@|$PKG_CPPFLAGS|" -e "s|@libs@|$PKG_LIBS|" -e"s|@rpath@|$rpath|" src/Makevars.in > src/Makevars

# Success
exit 0

