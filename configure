#!/bin/sh

# Library settings
PKG_TEST_HEADER="<kiwi/Kiwi.h>"
PKG_LIBS=""
PKG_CPPFLAGS=""
LIB_VER="0.10.3"

# Check for custom locations
if [ "$INCLUDE_DIR" ] || [ "$LIB_DIR" ]; then
  echo "Found INCLUDE_DIR and/or LIB_DIR!"
  PKG_CPPFLAGS="-I$INCLUDE_DIR $PKG_CPPFLAGS"
  PKG_LIBS="-L$LIB_DIR $PKG_LIBS"

elif [ -d "`pwd`/include/kiwi" ]; then
  echo "Found libkiwi on pwd installation..."
  PKG_CPPFLAGS="-I`pwd`/include $PKG_CPPFLAGS"
  PKG_LIBS="-L`pwd`/lib $PKG_LIBS"

else
  echo "Prior system libkiwi installation not found"
  echo "Preparing to download and build library from source..."
  git clone -b v$LIB_VER https://github.com/bab2min/Kiwi
  cd Kiwi
  git submodule update --init --recursive
  cd third_party/googletest && git checkout v1.8.x && cd ../../
  mkdir build
  cd build
  which cmake
  if [ $? -ne 0 ]; then
    export PATH=$PATH:/Applications/CMake.app/Contents/bin
  fi
  cmake -DCMAKE_BUILD_TYPE=Release ..
  make
  cd ../..
  mkdir lib
  mv -f Kiwi/build/libkiwi* lib
  mv -f Kiwi/include ./
  rm -rf Kiwi
  PKG_CPPFLAGS="-I`pwd`/include $PKG_CPPFLAGS"
  PKG_LIBS="-L`pwd`/lib $PKG_LIBS"
fi

# For debugging
echo "Using PKG_CPPFLAGS=$PKG_CPPFLAGS"
echo "Using PKG_LIBS=$PKG_LIBS"

# Find compiler
CXX11=`${R_HOME}/bin/R CMD config CXX11`
CFLAGS=`${R_HOME}/bin/R CMD config CFLAGS`

# Test for libkiwi
echo "#include $PKG_TEST_HEADER" | ${CXX11} ${PKG_CPPFLAGS} ${CFLAGS} -E -xc++ - >/dev/null 2>configure.log

if [ $? -ne 0 ]; then
  if [ "$SYS_LIB" -ne 1 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' was not found."
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo "-------------------------------------------------------------------------"
    exit 1
  else
    echo "Attempt to use system libkiwi failed"
    echo "Preparing to download and build library from source..."
    git clone -b v$LIB_VER https://github.com/bab2min/Kiwi
    cd Kiwi
    git submodule update --init --recursive
    cd third_party/googletest && git checkout v1.8.x && cd ../../
    mkdir build
    cd build
    which cmake
    if [ $? -ne 0 ]; then
      export PATH=$PATH:/Applications/CMake.app/Contents/bin
    fi
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make
    cd ../..
    mkdir lib
    mv -f Kiwi/build/libkiwi* lib
    mv -f Kiwi/include ./
    rm -rf Kiwi
    PKG_CPPFLAGS="-I`pwd`/include $PKG_CPPFLAGS"
    PKG_LIBS="-L`pwd`/lib $PKG_LIBS"
    # Test for libkiwi
    echo "#include $PKG_TEST_HEADER" | ${CXX11} ${PKG_CPPFLAGS} ${CFLAGS} -E -xc++ - >/dev/null 2>configure.log
    if [ $? -ne 0 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' was not found."
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo "-------------------------------------------------------------------------"
      exit 1
    fi
  fi
fi

# Write to Makevars
sed -e "s|@cppflags@|$PKG_CPPFLAGS|" -e "s|@libs@|$PKG_LIBS|" src/Makevars.in > src/Makevars

# Success
exit 0

