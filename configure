#!/bin/sh

# Library settings
PKG_TEST_HEADER="<kiwi/Kiwi.h>"
PKG_LIBS="-lkiwi"
PKG_CFLAGS=""
LIB_VER="0.10.3"

# Check for custom locations
if [ "$INCLUDE_DIR" ] || [ "$LIB_DIR" ]; then
  echo "Found INCLUDE_DIR and/or LIB_DIR!"
  PKG_CFLAGS="-I$INCLUDE_DIR $PKG_CFLAGS"
  PKG_LIBS="-L$LIB_DIR $PKG_LIBS"

elif [ -d "`pwd`/include/kiwi" ]; then
  echo "Found libkiwi on pwd installation..."
  PKG_CFLAGS="-I`pwd`/include $PKG_CFLAGS"
  PKG_LIBS="-L`pwd`/lib $PKG_LIBS"

else
  echo "Prior system libkiwi installation not found"
  echo "Preparing to download and build library from source..."
  git clone -b v$LIB_VER https://github.com/bab2min/Kiwi
  cd Kiwi
  git submodule update --init --recursive
  cd third_party/googletest && git checkout v1.8.x && cd ../../
  mkdir build
  cd build
  which cmake
  if [ $? -ne 0 ]; then
    export PATH=$PATH:/Applications/CMake.app/Contents/bin
  fi
  cmake -DCMAKE_BUILD_TYPE=Release ..
  make
  cd ../..
  mkdir lib
  mv -f Kiwi/build/libkiwi* lib
  mv -f Kiwi/include ./
  rm -rf Kiwi
  PKG_CFLAGS="-I`pwd`/include $PKG_CFLAGS"
  PKG_LIBS="-L`pwd`/lib $PKG_LIBS"
fi

# For debugging
echo "Using PKG_CFLAGS=$PKG_CFLAGS"
echo "Using PKG_LIBS=$PKG_LIBS"

# Find compiler
CXX11=`${R_HOME}/bin/R CMD config CXX11`
CFLAGS=`${R_HOME}/bin/R CMD config CFLAGS`

# Test for libkiwi
echo "#include $PKG_TEST_HEADER" | ${CXX11} ${PKG_CFLAGS} ${CFLAGS} -E -xc++ - >/dev/null 2>&1

if [ $? -ne 0 ]; then
  if [ "$SYS_LIB" -ne 1 ]; then
    echo "------------------------------[ ELBIRD ]------------------------------"
    echo "Configuration failed because 'libkiwi' was not found."
    echo "Automatic download and/or build also failed. Try installing:"
    echo " * deb: libkiwi-dev (Debian, Ubuntu, etc.)"
    echo " * rpm: kiwi-devel (Fedora, CentOS etc.)"
    echo " * arch: https://aur.archlinux.org/kiwi.git (Arch from AUR)"
    echo " * brew: kiwi (MacOS)"
    echo "Alternatively:"
    echo " * vcpkg: kiwi (Linux/MacOS, follow getting started instructions at"
    echo "               https://vcpkg.io/ starting from your HOME directory)"
    echo "If 'libkiwi' is already installed but in a non-standard location, you"
    echo "may set INCLUDE_DIR and LIB_DIR manually via:"
    echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
    echo "-------------------------------------------------------------------------"
    exit 1
  else
    echo "Attempt to use system libkiwi failed"
    echo "Preparing to download and build library from source..."
    git clone -b v$LIB_VER https://github.com/bab2min/Kiwi
    cd Kiwi
    git submodule update --init --recursive
    cd third_party/googletest && git checkout v1.8.x && cd ../../
    mkdir build
    cd build
    which cmake
    if [ $? -ne 0 ]; then
      export PATH=$PATH:/Applications/CMake.app/Contents/bin
    fi
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make
    cd ../..
    mkdir lib
    mv -f Kiwi/build/libkiwi* lib
    mv -f Kiwi/include ./
    rm -rf Kiwi
    PKG_CFLAGS="-I`pwd`/include $PKG_CFLAGS"
    PKG_LIBS="-L`pwd`/lib $PKG_LIBS"
    # Test for libkiwi
    echo "#include $PKG_TEST_HEADER" | ${CXX11} ${PKG_CFLAGS} ${CFLAGS} -E -xc++ - >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      echo "------------------------------[ NANONEXT ]------------------------------"
      echo "Configuration failed because 'libkiwi' was not found."
      echo "Automatic download and/or build also failed. Try installing:"
      echo " * deb: libkiwi-dev (Debian, Ubuntu, etc.)"
      echo " * rpm: kiwi-devel (Fedora, CentOS etc.)"
      echo " * arch: https://aur.archlinux.org/kiwi.git (Arch from AUR)"
      echo " * brew: kiwi (MacOS)"
      echo "Alternatively:"
      echo " * vcpkg: kiwi (Linux/MacOS, follow getting started instructions at"
      echo "               https://vcpkg.io/ starting from your HOME directory)"
      echo "If 'libkiwi' is already installed but in a non-standard location, you"
      echo "may set INCLUDE_DIR and LIB_DIR manually via:"
      echo "R CMD INSTALL --configure-vars='INCLUDE_DIR=... LIB_DIR=...'"
      echo "-------------------------------------------------------------------------"
      exit 1
    fi
  fi
fi

# Write to Makevars
sed -e "s|@cflags@|$PKG_CFLAGS|" -e "s|@libs@|$PKG_LIBS|" src/Makevars.in > src/Makevars

# Success
exit 0

